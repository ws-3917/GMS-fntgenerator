# å­—å›¾é…ç½®ç”Ÿæˆä¸»ç¨‹åº - 0616é‡ç½®ç‰ˆ
import csv, json
from PIL import Image, ImageFont, ImageDraw
from termcolor import colored

# å­—å›¾ç±»ï¼Œæ¯ä¸ªå­—ä½“ç‹¬ç«‹
class FontGlyph:
    # æ‰€å±é¡¹ç›®ï¼ˆç”¨æ¥æŸ¥è¯¢è·¯å¾„ï¼‰ï¼Œè¯­è¨€åˆ—è¡¨ï¼Œå­—å›¾å®½åº¦
    def __init__(self, project : str, langlist : list, totalwidth:int = 2048):
        self.project = project
        self.langlist = langlist
        self.totalwidth = totalwidth
        self.rest = 2   # æ¾å¼›é—´éš”ï¼Œé˜²æ­¢è¡Œä¹‹é—´é‡å 
        # æ ¹æ®projectè¯»å–å¯¹åº”è·¯å¾„ä¸‹çš„base,è·å–å­—ä½“åˆ—è¡¨å’ŒåŸºæœ¬ä¿¡æ¯
        with open(f"info/{self.project}/base.json", encoding="utf-8") as file:
            self.baseinfo = dict(json.loads(file.read()))
        self.fontlist = tuple(self.baseinfo.keys())

        # é¢„åŠ è½½æ‰€æœ‰é…ç½®ä¿¡æ¯åˆ°å†…å­˜
        self.fontinfo = dict()
        self.charset = dict()
        for lang in self.langlist:
            with open(f"info/{self.project}/{lang}.json", encoding="utf-8") as file:
                self.fontinfo[lang] = dict(json.loads(file.read()))
            with open(f"charset/{lang}.txt", encoding="utf-8") as file:
                self.charset[lang] = file.read()
        
        # è¯»å–fallbackå­—ä½“ä¿¡æ¯
        with open(f"info/{self.project}/fallback.json", encoding="utf-8") as file:
            self.fallbackinfo = dict(json.loads(file.read()))
    
    # è·å–å­—ä½“å¤§å°
    def loadsize(self, font) -> None:
        self.fontsize = dict()
        testfont = ["A", "g", "èµ¢"]     # ç”¨æ¥ç¡®å®šå­—ä½“å®é™…å¤§å°çš„æµ‹è¯•ç”¨æ±‰å­—
        for lang in self.langlist:
            fontobj = ImageFont.truetype(
                f"fonts/{lang}/" + self.fontinfo[lang][font]["fontfile"], 
                self.fontinfo[lang][font]["size"]
            )
            self.fontsize[lang] = (
                max([fontobj.getbbox(ch)[2] for ch in testfont]),
                max([fontobj.getbbox(ch)[3] for ch in testfont]),
            )
    
    # è‡ªåŠ¨è®¡ç®—å›¾ç‰‡é«˜åº¦
    def totalheight(self, font) -> int:
        height = 0
        for lang in self.langlist:
            charcount = len(self.charset[lang]) # å­—ç¬¦æ•°
            char_perline = self.totalwidth // (
                self.fontinfo[lang][font].get("extra_x", 0) + self.fontsize[lang][0]
            )
            height += (self.fontsize[lang][1] + self.rest) * (charcount // char_perline + 1)
        return height

    def check(self, ch) -> str:
        # ç‰¹æ®Šå­—ç¬¦ç›´æ¥æ”¾è¡Œæˆ–è·³è¿‡
        if ch in [' ', 'ã€€']:
            return 'yep'
        if ch == '\n':
            return 'nope'
        testglyph = Image.new("1", (self.width, self.height), 0)
        ImageDraw.Draw(testglyph).text((0, 0), chr(ord(ch) % 0xfee0), 
                                       fill=1, font=self.enfont if ord(ch) > 0xfee0 else self.font)  
        # æ£€æŸ¥å­—å›¾
        if testglyph != self.fail:
            return 'yep'
        # å°è¯•ä½¿ç”¨fallback
        elif self.fallbackcfg:
            ImageDraw.Draw(testglyph).text((0, 0), ch, fill=1, font=self.fallbackfont)
            if testglyph != self.fallbackfail:
                return 'fallback'
            else:
                return 'nope'
        else:
            return 'nope'
    
    def addfont(self, ch, fallback=False) -> None:
        # å…ˆè·å–åŸºæœ¬ä¿¡æ¯
        if fallback:
            cfg = self.fallbackcfg
            font = self.fallbackfont
        elif ord(ch) > 0xfee0:
            cfg = self.encfg
            font = self.enfont
        else:
            cfg = self.cfg
            font = self.font
        start_x = cfg.get("start_x", 0)
        start_y = cfg.get("start_y", 0)
        width = cfg.get("extra_x", 0) + self.width
        height = cfg.get("extra_y", 0) + self.height

        # æ£€æŸ¥æ˜¯å¦æœ‰å•ç‹¬çš„æ§åˆ¶
        specials = cfg.get("special", {})
        if ch in specials:
            specialcfg = specials[ch]
            start_x += specialcfg.get("start_x", 0)
            start_y += specialcfg.get("start_y", 0)
            width += specialcfg.get("extra_x", 0)
            height += specialcfg.get("extra_y", 0)

        # æ£€æŸ¥æ˜¯å¦ä¼šæ¢è¡Œ
        if self.x + width > self.totalwidth:
            self.x = 0
            self.y += self.height + self.rest
        
        # å¼€å§‹ç»˜åˆ¶
        self.drawtool.text((self.x + start_x, self.y + start_y),
                           chr(ord(ch) % 0xfee0), fill=(255, 255), font=font)

        # æ·»åŠ csvæ•°æ®
        self.csv.append((ord(ch), self.x, self.y, width, height,
                         0, 0, width, height))

        # ç§»åŠ¨ç”»ç¬”ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡ç»˜åˆ¶
        self.x += width
   
    # ä¸»ä»»åŠ¡ï¼šç”Ÿæˆå­—å›¾
    def task(self) -> None:
        # å¯¹äºæ¯ä¸ªå­—ä½“
        for font in self.fontlist:
            # åˆ›å»ºæ–°å­—å›¾
            print(colored(f"--> {font}", "blue"))
            self.loadsize(font)
            self.glyph = Image.new('LA', (self.totalwidth, self.totalheight(font)), (0, 0))
            self.drawtool = ImageDraw.Draw(self.glyph)
            self.x = 0
            self.prev_y = self.y = 0
            self.csv = [tuple(self.baseinfo[font].values())]
            # é’ˆå¯¹æ¯ç§è¯­è¨€
            for lang in self.langlist:
                # åŠ è½½é…ç½®æ–‡ä»¶å’Œå­—ç¬¦é›†
                print(colored(f" -> {lang}", "yellow"))
                (self.width, self.height) = self.fontsize[lang]
                self.cfg = self.fontinfo[lang][font]
                self.font = ImageFont.truetype(f"fonts/{lang}/" + self.cfg["fontfile"], self.cfg["size"])
                if lang == "en_US":
                    self.encfg = self.cfg
                    self.enfont = self.font
                self.fallbackcfg = self.fallbackinfo.get(self.cfg.get("fallback"))
                if self.fallbackcfg:
                    self.fallbackfont = ImageFont.truetype(f"fonts/{lang}/" + self.fallbackcfg["fontfile"], self.fallbackcfg["size"])
                    self.fallbackfail = Image.new("1", (self.width, self.height), 0)
                    ImageDraw.Draw(self.fail).text((0, 0), "ğ˜š", fill=1, font=self.fallbackfont)
                
                # ç”Ÿæˆç»˜åˆ¶å¤±è´¥å­—ç¬¦å›¾
                self.fail = Image.new("1", (self.width, self.height), 0)
                ImageDraw.Draw(self.fail).text((0, 0), "ğ˜š", fill=1, font=self.font)
                # å¼€å§‹é€ä¸€ç»˜åˆ¶å­—ç¬¦
                for ch in self.charset[lang]:
                    # æ£€æŸ¥å­—ç¬¦æ˜¯å¦å¯ç”¨
                    status = self.check(ch) # è¿”å›å€¼æœ‰ yep, nope, fallback
                    if status == 'yep':
                        self.addfont(ch)    # addfontæœ‰csvçš„æ·»åŠ 
                    elif status == 'fallback':
                        print(colored(f"  ! ä½¿ç”¨å¤‡ç”¨å­—ä½“: {ch}", "magenta"))
                        self.addfont(ch, fallback=True)
                    elif status == 'nope':
                        if ch != '\n':
                            print(colored(f"  ! æ— æ³•ç»˜åˆ¶: {ch}", "red"))
                        continue
                # å®Œæ¯•åè°ƒæ•´åæ ‡ä½
                self.x = 0
                self.y += self.height + self.rest   # æ­¤å¤„å’Œä¹‹å‰ç®—heightçš„+restéƒ½æ˜¯ä¸ºäº†é¿å…é‡å æ‰“çš„è¡¥ä¸
                # å¤„ç†é€æ˜åº¦
                pixel = self.glyph.load()
                threshold = max(self.cfg.get("threshold", 0), 0)
                for x in range(self.totalwidth):
                    for y in range(self.prev_y, self.y):
                        pixel[x, y] = (pixel[x, y][0], 255 * int(pixel[x, y][1] > threshold))
            # å…¨éƒ¨ç»“æŸåï¼Œä¿å­˜å›¾ç‰‡å’Œcsvåˆ°æ–‡ä»¶
            self.glyph.save(f"dist/{self.project}/{font}.png")
            with open(f"dist/{self.project}/{font}.csv", "w", encoding="utf-8", newline='') as file:
                self.writer = csv.writer(file, delimiter=';')
                self.writer.writerows(self.csv)